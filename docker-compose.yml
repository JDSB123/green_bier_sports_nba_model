# NBA v5.1 FINAL - Docker Compose Production Configuration
# 
# 6 PROVEN ROE Markets (Full Game + First Half):
#
# Full Game:
# - Spread: 60.6% accuracy, +15.7% ROI
# - Total: 59.2% accuracy, +13.1% ROI
# - Moneyline: 65.5% accuracy, +25.1% ROI
#
# First Half:
# - Spread: 55.9% accuracy, +8.2% ROI
# - Total: 58.1% accuracy, +11.4% ROI
# - Moneyline: 63.0% accuracy, +19.8% ROI
#
# Build:   docker compose build
# Run:     docker compose up -d
# Export:  docker save nba-v51-final:latest | gzip > nba_v5.1_model_FINAL.tar.gz

version: "3.8"

services:
  # ==========================================================================
  # NBA v5.1 FINAL - Production API (Read-Only Mode)
  # ==========================================================================
  nba-v51-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: nba-v51-final:latest
    container_name: nba-v51-final
    
    # Security: Read-only root filesystem
    read_only: true
    
    # Temporary filesystems for runtime needs
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /app/outputs:size=50M,uid=1000,gid=1000,mode=0755
    
    ports:
      - "8090:8080"
    
    # SECRETS ARE BAKED INTO CONTAINER - No volume mount required
    # Secrets are copied from ./secrets/ into /app/secrets/ at build time
    # Container is fully self-contained - no external secrets needed
    
    environment:
      # Optional auth
      - REQUIRE_API_AUTH=${REQUIRE_API_AUTH:-false}
      - SERVICE_API_KEY=${SERVICE_API_KEY:-}
      
      # v5.1 configuration (6 markets)
      - NBA_MODEL_VERSION=5.1-FINAL
      - NBA_MARKETS=fg_spread,fg_total,fg_moneyline,1h_spread,1h_total,1h_moneyline
      - NBA_PERIODS=full_game,first_half
      
      # CORS (customize as needed)
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8090
    
    # Health check (override container healthcheck for compose)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; r=urllib.request.urlopen('http://localhost:8080/health', timeout=5); import json; d=json.loads(r.read()); exit(0 if d.get('engine_loaded') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    # NO AUTO-RESTART - Container only runs when manually triggered
    # Start:  docker compose up -d
    # Stop:   docker compose down
    restart: "no"

  # ==========================================================================
  # Optional: Model Output Volume for persistence
  # ==========================================================================
  # Uncomment to persist model outputs outside container
  # volumes:
  #   - nba-outputs:/app/outputs

# Optional: Named volume for persistent outputs
# volumes:
#   nba-outputs:
#     driver: local


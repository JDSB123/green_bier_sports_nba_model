# Totals Market Optimization - Complete Guide

## Quick Start

To optimize totals markets (1H and FG), follow these steps:

### 1. Run the Optimization

**Option A: Using the batch file (Recommended for Windows)**
```batch
# Double-click or run from command prompt
run_totals_optimization.bat
```

**Option B: Using Python directly**
```bash
cd c:\Users\JDSB\dev\green_bier_sport_ventures\nba_gbsv_local
python scripts\optimize_totals_only.py
```

**Option C: Using the alternative method (separate runs)**
```batch
run_totals_optimization_alternative.bat
```

### 2. Analyze the Results

```bash
python scripts\analyze_totals_results.py
```

This will:
- Load the optimization results
- Identify best parameters for each market
- Compare FG vs 1H performance
- Generate deployment recommendations
- Save a comprehensive summary

### 3. Review Documentation

Open the results template to see detailed findings:
- `TOTALS_OPTIMIZATION_RESULTS_TEMPLATE.md` - Fill in with actual results

---

## Files Created

### Optimization Scripts

| File | Purpose | When to Use |
|------|---------|-------------|
| `scripts/optimize_totals_only.py` | Run comprehensive totals optimization in one go | Primary optimization method |
| `run_totals_optimization.bat` | Windows batch file to run optimization | Easiest way to start on Windows |
| `run_totals_optimization_alternative.bat` | Alternative using existing framework | If primary script has issues |

### Analysis Scripts

| File | Purpose | When to Use |
|------|---------|-------------|
| `scripts/analyze_totals_results.py` | Analyze and summarize optimization results | After running optimization |

### Documentation

| File | Purpose | When to Use |
|------|---------|-------------|
| `TOTALS_OPTIMIZATION_GUIDE.md` | Comprehensive methodology guide | Before running optimization |
| `TOTALS_OPTIMIZATION_RESULTS_TEMPLATE.md` | Results template to fill in | After running optimization |
| `README_TOTALS_OPTIMIZATION.md` | This file - quick reference | Starting point |

### Output Files (Generated)

| File | Content | Generated By |
|------|---------|--------------|
| `data/backtest_results/totals_optimization_TIMESTAMP.json` | Raw optimization results | optimize_totals_only.py |
| `data/backtest_results/fg_total_optimization.json` | FG totals results | Alternative method |
| `data/backtest_results/1h_total_optimization.json` | 1H totals results | Alternative method |
| `data/backtest_results/totals_optimization_summary.json` | Analysis summary | analyze_totals_results.py |

---

## What the Optimization Does

### Parameter Grids Tested

**Confidence Thresholds**: 0.55, 0.57, 0.59, 0.61, 0.63, 0.65, 0.67, 0.69, 0.71, 0.73, 0.75, 0.77, 0.79 (13 values)

**Edge Thresholds**: 0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0 (13 values)

**Total Combinations**: 169 per market (338 total)

### Markets Optimized

1. **FG Totals** (Full Game Over/Under)
   - Current thresholds: confidence >= 0.72, edge >= 3.0
   - Optimized to maximize ROI

2. **1H Totals** (First Half Over/Under)
   - Current thresholds: confidence >= 0.66, edge >= 2.0
   - Optimized to maximize ROI

### Metrics Calculated

For each parameter combination:
- **Bet Volume**: Number of qualifying bets
- **Win Rate**: Percentage of winning bets
- **Accuracy**: Same as win rate (for clarity)
- **ROI**: Return on investment (%)
- **Profit**: Total units won/lost
- **Statistical Significance**: At least 30 bets required

---

## Understanding the Results

### Output Structure

The optimization produces a JSON file with this structure:

```json
{
  "timestamp": "2026-01-15T...",
  "config": {
    "data_path": "...",
    "markets": ["fg_total", "1h_total"],
    "confidence_grid": [...],
    "edge_grid": [...]
  },
  "baseline": {
    "fg_total": {
      "n_bets": 1000,
      "accuracy": 0.52,
      "roi": -2.5,
      "profit": -25.0
    },
    "1h_total": {...}
  },
  "optimization_results": {
    "fg_total": [
      {
        "confidence_threshold": 0.75,
        "edge_threshold": 3.5,
        "n_bets": 120,
        "wins": 70,
        "accuracy": 0.583,
        "roi": 4.2,
        "profit": 5.04
      },
      // ... more combinations ranked by ROI
    ],
    "1h_total": [...]
  }
}
```

### Key Sections to Review

1. **Baseline Performance**: Shows results with NO filters (all bets)
   - Usually negative ROI (betting everything is -EV)
   - Provides context for improvement

2. **Optimization Results**: Ranked list of parameter combinations
   - Sorted by ROI (highest first)
   - Top 10-20 are most interesting

3. **Sweet Spot**: Balance of ROI and volume
   - ROI > 2%
   - Bet volume >= 50
   - Recommended for deployment

---

## Interpreting the Analysis

### What to Look For

1. **Best ROI**: Highest percentage return
   - May have low bet volume
   - Good for maximizing profit per bet
   - Risk: Few bets = high variance

2. **Best Volume**: Most bets with positive ROI
   - Lower ROI but more betting opportunities
   - Better for bankroll growth
   - Risk: Lower edge = more sensitive to variance

3. **Sweet Spot**: Balance of both
   - Recommended starting point
   - Adequate volume + good ROI
   - Best risk/reward trade-off

### Example Interpretation

```
FG TOTALS - Top Result:
  Confidence >= 0.75
  Edge >= 3.5
  120 bets, 58.3% accuracy, 4.2% ROI, +5.04 units

This means:
- Only bet when model confidence is 75%+
- Only bet when edge over line is 3.5+ points
- Historically: 120 qualifying bets
- Win rate: 58.3% (above 52.38% break-even)
- Expected return: 4.2% profit on every dollar wagered
- Total profit: 5.04 units (if betting 1 unit per bet)
```

---

## Implementation Workflow

### Step 1: Run Optimization
```bash
run_totals_optimization.bat
# OR
python scripts/optimize_totals_only.py
```

**Expected Duration**: 5-15 minutes depending on data size

**Output**: JSON file in `data/backtest_results/`

### Step 2: Analyze Results
```bash
python scripts/analyze_totals_results.py
```

**Output**:
- Console summary with top combinations
- Summary JSON for further analysis
- Deployment recommendations

### Step 3: Review & Decide

Review the analysis output and decide on parameters:

**Questions to Answer:**
- What's the optimal ROI vs volume trade-off for your goals?
- Do you prioritize maximum profit or maximum betting opportunities?
- Are the optimized parameters significantly better than current?
- Is the bet volume sufficient for your strategy?

### Step 4: Update Configuration

Edit `src/config.py`:

```python
@dataclass(frozen=True)
class FilterThresholds:
    # Update these values based on optimization results

    # FG Total thresholds
    total_min_confidence: float = field(
        default_factory=lambda: _env_float_required("FILTER_TOTAL_MIN_CONFIDENCE", 0.XX)  # NEW VALUE
    )
    total_min_edge: float = field(
        default_factory=lambda: _env_float_required("FILTER_TOTAL_MIN_EDGE", X.X)  # NEW VALUE
    )

    # 1H Total thresholds
    fh_total_min_confidence: float = field(
        default_factory=lambda: _env_float_required("FILTER_1H_TOTAL_MIN_CONFIDENCE", 0.XX)  # NEW VALUE
    )
    fh_total_min_edge: float = field(
        default_factory=lambda: _env_float_required("FILTER_1H_TOTAL_MIN_EDGE", X.X)  # NEW VALUE
    )
```

### Step 5: Test Before Deployment

**Backtest on Recent Data:**
```bash
python scripts/backtest_production.py \
  --markets total \
  --spread-juice -110 \
  --total-juice -110 \
  --start-date 2025-12-01 \
  --end-date 2026-01-15
```

**Verify**:
- Performance matches optimization expectations
- No data issues or anomalies
- Parameters work well on recent games

### Step 6: Deploy to Production

1. **Update Environment Variables** (if using env-based config):
   ```bash
   export FILTER_TOTAL_MIN_CONFIDENCE=0.XX
   export FILTER_TOTAL_MIN_EDGE=X.X
   export FILTER_1H_TOTAL_MIN_CONFIDENCE=0.XX
   export FILTER_1H_TOTAL_MIN_EDGE=X.X
   ```

2. **Restart Prediction Service**

3. **Monitor Initial Performance**:
   - First 10 bets: Check predictions are being generated
   - First 20 bets: Early accuracy check
   - First 50 bets: Statistical significance starting to appear
   - First 100 bets: Full validation

---

## Troubleshooting

### Problem: Optimization takes too long

**Solution**: Reduce parameter grid size
- Use larger step sizes (e.g., 0.05 for confidence, 1.0 for edge)
- Narrow the range (e.g., 0.60-0.75 instead of 0.55-0.79)

### Problem: All ROIs are negative

**Possible Causes**:
- Models need retraining
- Market conditions have changed
- Odds assumptions incorrect

**Solution**:
- Check model performance with `--no-pricing` flag
- Verify accuracy is above 52.38% break-even
- Review training data freshness

### Problem: Not enough bets (< 30) for any combination

**Possible Causes**:
- Thresholds too aggressive
- Limited historical data
- Markets have sparse line coverage

**Solution**:
- Lower minimum bet threshold to 20
- Expand parameter grids (lower minimums)
- Check data quality and line coverage

### Problem: High variance in results

**Possible Causes**:
- Small sample size
- Seasonal effects
- Market regime changes

**Solution**:
- Focus on combinations with 50+ bets
- Check seasonal performance breakdown
- Consider using more conservative thresholds

---

## Best Practices

### 1. Regular Re-optimization

**Frequency**: Monthly or quarterly

**Why**: Markets evolve, team strengths change, betting lines adapt

**How**: Re-run optimization with latest data

### 2. Out-of-Sample Validation

**Always test on data not used in optimization**

**Methods**:
- Time-based split (train on older, test on newer)
- Rolling window validation
- Cross-validation

### 3. Monitor Live Performance

**Track**:
- Actual vs expected ROI
- Actual vs expected win rate
- Bet volume trends
- Bankroll changes

**Alert if**:
- ROI drops below 0% for 30+ bets
- Win rate falls below 50% for 30+ bets
- Bet volume drops by 50%+

### 4. Conservative Bankroll Management

**Never bet more than 2-3% of bankroll per bet**

**Use fractional Kelly** (25-50% of full Kelly)

**Example**:
- Bankroll: $10,000
- Kelly suggests 5% per bet
- Conservative: Use 2.5% (half Kelly) = $250 max bet
- Safe: Use 1.5% = $150 per bet

### 5. Document Everything

**Keep records of**:
- Optimization parameters used
- Results and decisions made
- Deployment dates
- Performance over time
- Any adjustments made

---

## Advanced Topics

### Multi-Objective Optimization

Instead of just maximizing ROI, consider:
- Maximize (ROI Ã— log(volume)) - Balances both metrics
- Maximize Sharpe ratio - Risk-adjusted returns
- Maximize Kelly criterion - Optimal bet sizing

### Seasonal Adjustments

Different parameters for:
- Early season (more variance)
- Mid season (optimal)
- Late season (playoff push)

### Team-Specific Analysis

Some teams may be:
- More predictable (higher confidence)
- Higher/lower scoring (affects totals)
- More affected by rest/travel

### Combining with Other Markets

Totals can be combined with:
- Same-game parlays (use with caution)
- Live betting (in-game adjustments)
- Alternative lines (better value)

---

## FAQ

**Q: How often should I re-optimize?**
A: Monthly during season, or when performance degrades

**Q: Should I use the same parameters all season?**
A: No, re-optimize regularly as conditions change

**Q: What if my live results don't match backtests?**
A: Monitor for 50+ bets, may be variance. If persistent, re-evaluate parameters.

**Q: Can I use different parameters for different teams?**
A: Yes, but requires more complex implementation. Start with universal parameters first.

**Q: What's more important: confidence or edge?**
A: Both matter. Optimization finds the best balance for your data.

**Q: How do I know if the improvement is real or luck?**
A: Require statistical significance (50+ bets) and validate on out-of-sample data

**Q: Should I bet every qualifying game?**
A: Yes, if parameters are properly optimized. Cherry-picking reduces expected value.

---

## Support & Resources

### Key Files Reference

- **Configuration**: `src/config.py`
- **Backtesting**: `scripts/backtest_production.py`
- **Optimization**: `scripts/optimize_totals_only.py`
- **Analysis**: `scripts/analyze_totals_results.py`
- **Models**: `models/production/fg_total_model.joblib`, `models/production/1h_total_model.joblib`
- **Data**: `data/processed/training_data.csv`

### Understanding the Code

The optimization works by:
1. Loading historical betting data
2. Loading production models
3. Making predictions on each game
4. Filtering predictions by confidence and edge thresholds
5. Calculating win rate and ROI for each parameter combination
6. Ranking combinations by performance
7. Identifying optimal parameters

### Next Steps

1. âœ… Run optimization
2. âœ… Analyze results
3. âœ… Choose parameters
4. âœ… Update configuration
5. âœ… Test on recent data
6. âœ… Deploy to production
7. âœ… Monitor performance
8. âœ… Re-optimize regularly

---

**Good luck with your totals optimization!** ðŸ€ðŸ“Š

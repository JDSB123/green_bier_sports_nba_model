name: ACR Retention

on:
  schedule:
    - cron: '0 6 * * 0' # Sundays 06:00 UTC
  workflow_dispatch:

env:
  ACR_NAME: nbagbsacr
  REPOSITORY: nba-gbsv-api
  KEEP: 12 # keep most recent 12 git-* tags

permissions:
  id-token: write
  contents: read

jobs:
  prune-old-git-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: List tags and determine deletions
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          # List git-* tags newest first
          TAGS=$(az acr repository show-tags -n "$ACR_NAME" --repository "$REPOSITORY" --orderby time_desc -o tsv | grep '^git-' || true)
          printf "%s\n" "$TAGS" | head -n "$KEEP" > keep.txt || true
          printf "%s\n" "$TAGS" | tail -n +$((KEEP+1)) > delete.txt || true
          KEEP_LIST=$(tr '\n' ' ' < keep.txt | sed 's/ *$//')
          DELETE_LIST=$(tr '\n' ' ' < delete.txt | sed 's/ *$//')
          echo "keep=$KEEP_LIST" >> "$GITHUB_OUTPUT"
          echo "delete=$DELETE_LIST" >> "$GITHUB_OUTPUT"
          echo "Will keep: $KEEP_LIST"
          echo "Will delete: $DELETE_LIST"

      - name: Delete old git-* tags
        if: steps.plan.outputs.delete != ''
        shell: bash
        run: |
          set -euo pipefail
          for tag in ${{ steps.plan.outputs.delete }}; do
            echo "Deleting $REPOSITORY:$tag"
            az acr repository delete -n "$ACR_NAME" --image "$REPOSITORY:$tag" --yes
          done

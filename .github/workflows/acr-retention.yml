name: ACR Retention

on:
  schedule:
    - cron: '0 6 * * 0' # Sundays 06:00 UTC
  workflow_dispatch:

env:
  ACR_NAME: nbagbsacr
  REPOSITORY: nba-gbsv-api
  KEEP: 12

permissions:
  id-token: write
  contents: read

jobs:
  prune-old-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: List and prune old tags
        run: |
          TAGS=$(az acr repository show-tags -n "$ACR_NAME" --repository "$REPOSITORY" --orderby time_desc -o tsv | grep '^git-' || true)
          DELETE=$(echo "$TAGS" | tail -n +$((KEEP+1)))
          for tag in $DELETE; do
            echo "Deleting $REPOSITORY:$tag"
            az acr repository delete -n "$ACR_NAME" --image "$REPOSITORY:$tag" --yes
          done
          echo "âœ“ Retention complete"

name: ACR Retention

on:
  schedule:
    - cron: '0 6 * * 0' # Sundays 06:00 UTC
  workflow_dispatch:

env:
  ACR_NAME: nbagbsacr
  REPOSITORY: nba-gbsv-api
  KEEP: 12 # keep most recent 12 git-* tags

permissions:
  id-token: write
  contents: read

jobs:
  prune-old-git-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve Azure credentials
        id: azure-creds
        shell: bash
        env:
          AZURE_CREDENTIALS_JSON: ${{ secrets.AZURE_CREDENTIALS }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os, sys
          output_path = os.environ["GITHUB_OUTPUT"]
          creds = os.environ.get("AZURE_CREDENTIALS_JSON", "").strip()
          if creds:
              try:
                  json.loads(creds)
              except json.JSONDecodeError as exc:
                  sys.stderr.write(f"AZURE_CREDENTIALS is not valid JSON: {exc}\n")
                  sys.exit(1)
              resolved = creds
          else:
              client_secret = os.environ.get("AZURE_CLIENT_SECRET", "").strip()
              if not client_secret:
                  sys.stderr.write("AZURE_CLIENT_SECRET is not configured. Provide AZURE_CREDENTIALS or AZURE_CLIENT_SECRET.\n")
                  sys.exit(1)
              resolved = json.dumps({
                  "clientId": os.environ.get("AZURE_CLIENT_ID", "").strip(),
                  "clientSecret": client_secret,
                  "subscriptionId": os.environ.get("AZURE_SUBSCRIPTION_ID", "").strip(),
                  "tenantId": os.environ.get("AZURE_TENANT_ID", "").strip(),
              })
          with open(output_path, "a", encoding="utf-8") as handle:
              handle.write(f"creds={resolved}\n")
          PY

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ steps.azure-creds.outputs.creds }}

      - name: List tags and determine deletions
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          # List git-* tags newest first
          TAGS=$(az acr repository show-tags -n "$ACR_NAME" --repository "$REPOSITORY" --orderby time_desc -o tsv | grep '^git-' || true)
          printf "%s\n" "$TAGS" | head -n "$KEEP" > keep.txt || true
          printf "%s\n" "$TAGS" | tail -n +$((KEEP+1)) > delete.txt || true
          KEEP_LIST=$(tr '\n' ' ' < keep.txt | sed 's/ *$//')
          DELETE_LIST=$(tr '\n' ' ' < delete.txt | sed 's/ *$//')
          echo "keep=$KEEP_LIST" >> "$GITHUB_OUTPUT"
          echo "delete=$DELETE_LIST" >> "$GITHUB_OUTPUT"
          echo "Will keep: $KEEP_LIST"
          echo "Will delete: $DELETE_LIST"

      - name: Delete old git-* tags
        if: steps.plan.outputs.delete != ''
        shell: bash
        run: |
          set -euo pipefail
          for tag in ${{ steps.plan.outputs.delete }}; do
            echo "Deleting $REPOSITORY:$tag"
            az acr repository delete -n "$ACR_NAME" --image "$REPOSITORY:$tag" --yes
          done

name: Monthly Repository Maintenance

on:
  schedule:
    # Run on the 1st of every month at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allow manual trigger
    inputs:
      fix:
        description: 'Automatically fix issues'
        required: false
        default: 'false'

permissions:
  contents: read
  issues: write

jobs:
  maintenance:
    name: Repository Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for size analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest git-filter-repo

      - name: Run maintenance check
        id: maintenance
        run: |
          pwsh scripts/repo-maintenance.ps1
        continue-on-error: true

      - name: Create maintenance issue if problems found
        if: steps.maintenance.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ðŸ”§ Monthly Maintenance: Issues Detected (${date})`;
            const body = `
            ## Repository Maintenance Report

            The automated monthly maintenance check has detected issues that need attention.

            ### Action Required

            1. Review the workflow run logs for details
            2. Run locally: \`pwsh scripts/repo-maintenance.ps1\`
            3. Fix issues manually or run with auto-fix: \`pwsh scripts/repo-maintenance.ps1 -Fix\`

            ### Common Issues

            - Version inconsistencies across files
            - Missing tags for current version
            - Large files in repository
            - Outdated CHANGELOG
            - Test failures

            ### Next Steps

            - [ ] Review maintenance report
            - [ ] Fix critical issues
            - [ ] Update documentation if needed
            - [ ] Close this issue when resolved

            ---
            *Automated by monthly-maintenance.yml workflow*
            *Run: ${{ github.run_id }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'automated']
            });

      - name: Post success comment
        if: steps.maintenance.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('âœ… Repository maintenance check passed!');
            console.log('No issues detected. Repository is in excellent condition.');

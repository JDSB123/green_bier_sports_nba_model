name: Version Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate-version:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Read VERSION file
        id: get_version
        run: |
          VERSION=$(cat VERSION | tr -d '\n' | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
      
      - name: Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^NBA_v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: NBA_v<MAJOR>.<MINOR>.<PATCH>.<BUILD>"
            exit 1
          fi
          echo "✅ Version format is valid"
      
      - name: Check version consistency in all files
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Checking version consistency: $VERSION"
          echo ""
          
          FAILED=0
          
          # Check src/serving/app.py
          echo "Checking src/serving/app.py..."
          if ! grep -q "\"NBA_MODEL_VERSION\", \"$VERSION\"" src/serving/app.py; then
            echo "❌ Version mismatch in src/serving/app.py"
            FAILED=1
          else
            echo "✅ src/serving/app.py"
          fi
          
          # Check src/prediction/engine.py
          echo "Checking src/prediction/engine.py..."
          if ! grep -q "\"NBA_MODEL_VERSION\", \"$VERSION\"" src/prediction/engine.py; then
            echo "❌ Version mismatch in src/prediction/engine.py"
            FAILED=1
          else
            echo "✅ src/prediction/engine.py"
          fi
          
          # Check models/production/model_pack.json
          echo "Checking models/production/model_pack.json..."
          if ! grep -q "\"version\": \"$VERSION\"" models/production/model_pack.json; then
            echo "❌ Version mismatch in models/production/model_pack.json"
            FAILED=1
          else
            echo "✅ models/production/model_pack.json"
          fi
          
          # Check tests/test_serving.py
          echo "Checking tests/test_serving.py..."
          if ! grep -q "\"version\": \"$VERSION\"" tests/test_serving.py; then
            echo "❌ Version mismatch in tests/test_serving.py"
            FAILED=1
          else
            echo "✅ tests/test_serving.py"
          fi
          
          # Check .github/copilot-instructions.md
          echo "Checking .github/copilot-instructions.md..."
          if ! grep -q "nba-gbsv-api:$VERSION" .github/copilot-instructions.md; then
            echo "❌ Version mismatch in .github/copilot-instructions.md"
            FAILED=1
          else
            echo "✅ .github/copilot-instructions.md"
          fi
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "❌ Version consistency check failed!"
            echo ""
            echo "To fix this, run:"
            echo "  python scripts/bump_version.py $VERSION"
            echo ""
            exit 1
          else
            echo "✅ All files have consistent version: $VERSION"
          fi
      
      - name: Check for version drift
        if: github.event_name == 'pull_request'
        run: |
          # Get the version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:VERSION | tr -d '\n' | tr -d '\r')
          PR_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "Main branch version: $MAIN_VERSION"
          echo "PR branch version:   $PR_VERSION"
          
          if [ "$MAIN_VERSION" != "$PR_VERSION" ]; then
            echo "⚠️  Version changed from $MAIN_VERSION to $PR_VERSION"
            echo ""
            echo "Please ensure:"
            echo "  1. Version bump follows VERSIONING.md guidelines"
            echo "  2. CHANGELOG or commit message documents the change"
            echo "  3. All files are updated (run: python scripts/bump_version.py $PR_VERSION)"
          else
            echo "ℹ️  Version unchanged"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Version Validation Complete"
          echo "=========================================="
          echo "Version: ${{ steps.get_version.outputs.version }}"
          echo ""

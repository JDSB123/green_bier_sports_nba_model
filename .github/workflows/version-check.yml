name: Version Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate-version:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run environment validator
        run: |
          # Run the unified validator (version check is part of it)
          python scripts/validate_environment.py --json || true
          # Still proceed with detailed version check below
      
      - name: Read VERSION file
        id: get_version
        run: |
          VERSION=$(cat VERSION | tr -d '\n' | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
      
      - name: Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # Accept both 3-part and 4-part versions:
          # - NBA_v<MAJOR>.<MINOR>.<PATCH>
          # - NBA_v<MAJOR>.<MINOR>.<PATCH>.<BUILD>
          if ! echo "$VERSION" | grep -qE '^NBA_v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: NBA_v<MAJOR>.<MINOR>.<PATCH>[.<BUILD>]"
            exit 1
          fi
          echo "✅ Version format is valid"
      
      - name: Check version consistency in all files
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Checking version consistency: $VERSION"
          echo ""
          
          FAILED=0
          
          # Check models/production/model_pack.json
          echo "Checking models/production/model_pack.json..."
          if ! grep -q "\"version\": \"$VERSION\"" models/production/model_pack.json; then
            echo "❌ Version mismatch in models/production/model_pack.json"
            FAILED=1
          else
            echo "✅ models/production/model_pack.json"
          fi
          
          echo "Checking model_pack git_tag..."
          if ! grep -q "\"git_tag\": \"$VERSION\"" models/production/model_pack.json; then
            echo "❌ git_tag mismatch in models/production/model_pack.json"
            FAILED=1
          else
            echo "✅ model_pack git_tag"
          fi
          
          echo "Checking model_pack ACR tag..."
          if ! grep -q "nba-gbsv-api:$VERSION" models/production/model_pack.json; then
            echo "❌ ACR tag mismatch in models/production/model_pack.json"
            FAILED=1
          else
            echo "✅ model_pack ACR tag"
          fi
          
          # Check models/production/feature_importance.json
          echo "Checking models/production/feature_importance.json..."
          if ! grep -q "\"version\": \"$VERSION\"" models/production/feature_importance.json; then
            echo "❌ Version mismatch in models/production/feature_importance.json"
            FAILED=1
          else
            echo "✅ models/production/feature_importance.json"
          fi
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "❌ Version consistency check failed!"
            echo ""
            echo "To fix this, run:"
            echo "  python scripts/bump_version.py $VERSION"
            echo ""
            exit 1
          else
            echo "✅ All files have consistent version: $VERSION"
          fi
      
      - name: Check for version drift
        if: github.event_name == 'pull_request'
        run: |
          # Get the version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:VERSION | tr -d '\n' | tr -d '\r')
          PR_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "Main branch version: $MAIN_VERSION"
          echo "PR branch version:   $PR_VERSION"
          
          if [ "$MAIN_VERSION" != "$PR_VERSION" ]; then
            echo "⚠️  Version changed from $MAIN_VERSION to $PR_VERSION"
            echo ""
            echo "Please ensure:"
            echo "  1. Version bump follows VERSIONING.md guidelines"
            echo "  2. CHANGELOG or commit message documents the change"
            echo "  3. All files are updated (run: python scripts/bump_version.py $PR_VERSION)"
          else
            echo "ℹ️  Version unchanged"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Version Validation Complete"
          echo "=========================================="
          echo "Version: ${{ steps.get_version.outputs.version }}"
          echo ""

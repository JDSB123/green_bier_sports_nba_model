# Azure Deployment Plan for NBA_main Project

## Goal
Deploy NBA production workloads to Azure Container Apps using Azure CLI and VS Code Azure extension, aligned to greenbier-enterprise-rg and existing enterprise resources.

## Project Information
AppName: nba-picks-api
- Technology Stack: Python (models/prediction + HTTP serving via container)
- Application Type: NBA model service with data ingestion scripts and verification utilities
- Containerization: Ready (Dockerfile at repo root; Docker Compose present)
- Dependencies:
  - Secrets: THE_ODDS_API_KEY, API_BASKETBALL_KEY (managed in Azure Key Vault: greenbier-keyvault)
  - Container Registry: greenbieracr
  - Observability: Log Analytics + Application Insights (recommended)
- Hosting Recommendation: Azure Container Apps for scalable, serverless container hosting
- Existing Mapping (per repo notes):
  - Resource Group: greenbier-enterprise-rg
  - Container App: nba-picks-api
  - ACR Image: greenbieracr.azurecr.io/nba-model:v6.0

## Azure Resources Architecture
> Install a Mermaid viewer to render this.
```mermaid
graph TD
  ACR[Azure Container Registry: greenbieracr]
  KV[Azure Key Vault: greenbier-keyvault]
  LA[Log Analytics Workspace]
  AI[Application Insights]
  CA[Container App: nba-picks-api]

  ACR --> CA
  KV -. managed identity .-> CA
  LA --> CA
  AI --> CA
```
- The Container App pulls images from Azure Container Registry.
- The Container App reads secrets from Key Vault via managed identity.
- Logs/metrics flow to Log Analytics and Application Insights.

## Recommended Azure Resources
- Application: nba-picks-api
  - Hosting Service Type: Azure Container Apps
  - SKU: Consumption (serverless), enable revisions; scale on HTTP traffic
  - Configuration:
    - language: python
    - dockerFilePath: ./Dockerfile
    - dockerContext: ./
    - Environment Variables: THE_ODDS_API_KEY, API_BASKETBALL_KEY (sourced from Key Vault)
  - Dependencies:
    - Name: greenbier-keyvault
      - Service Type: Azure Key Vault
      - SKU: Standard
      - Connection Type: user-managed identity
      - Environment Variables: none (references are configured in Container App with secret bindings)
- Supporting Services:
  - Application Insights (for request and dependency telemetry)
  - Log Analytics Workspace (Container Apps diagnostics)
  - Container Registry: greenbieracr

### Recommended Security Configurations
- Assign a user-managed identity to the Container App.
- Grant the identity AcrPull role (7f951dda-4ed3-4680-a7ca-43fe172d538d) on the Container Registry.
- Grant least-privileged access to Key Vault secrets via access policies or RBAC.

## Execution Steps
1. Provision/Validate Azure Infrastructure
   - Ensure resource group `greenbier-enterprise-rg` exists.
   - Ensure ACR `greenbieracr` exists and is accessible.
   - Ensure Key Vault `greenbier-keyvault` holds THE-ODDS-API-KEY and API-BASKETBALL-KEY.
   - Ensure Application Insights and Log Analytics are linked to Container Apps environment.

2. Build and Push Docker Image
   - Confirm Dockerfile path: `./Dockerfile` (Python base, requirements.txt).
   - Build locally and tag: `greenbieracr.azurecr.io/nba-model:<tag>`.
   - Login to ACR and push the image.

3. Deploy/Update Azure Container App
   - Update `nba-picks-api` to new image tag.
   - Confirm secret bindings from Key Vault.
   - Restart revision if needed and verify rollout.

4. Validation
   - Call health endpoint: `https://<app-fqdn>/health` and confirm 200 OK.
   - Confirm logs in Log Analytics and telemetry in Application Insights.

5. Summary
   - Record deployment changes and the image tag.
   - Capture a diagram of provisioned resources and reference this plan.

## Quick Reference Commands
- Build and push:
```
az login
az account set --subscription "<subscription-name-or-id>"
az acr login -n greenbieracr

docker build -t greenbieracr.azurecr.io/nba-model:<tag> .
docker push greenbieracr.azurecr.io/nba-model:<tag>
```
- Update Container App:
```
az containerapp update \
  -n nba-picks-api \
  -g greenbier-enterprise-rg \
  --image greenbieracr.azurecr.io/nba-model:<tag>
```
- Verify health:
```
curl -s https://<app-fqdn>/health
```

Notes:
- Do not hardcode secrets; use Key Vault references.
- Maintain `master` branch usage for the separate model repo when building remote images.

# NBA Basketball Prediction System
# Backtest Environment - Docker Compose
#
# This is the SINGLE SOURCE OF TRUTH for running backtests.
#
# Usage:
#   # Full backtest (use canonical training_data.csv + run backtest)
#   docker compose -f docker-compose.backtest.yml up backtest-full
#
#   # Confirm canonical training data
#   docker compose -f docker-compose.backtest.yml up backtest-data
#
#   # Run backtest on existing data
#   docker compose -f docker-compose.backtest.yml up backtest-only
#
#   # Interactive shell for debugging
#   docker compose -f docker-compose.backtest.yml run --rm backtest-shell
#
# Required Environment:
#   Copy .env.example to .env and fill in your API keys
services:
  # ─────────────────────────────────────────────────────────────────────────
  # FULL BACKTEST PIPELINE
  # Uses canonical training_data.csv (2023+) and runs all market backtests
  # ─────────────────────────────────────────────────────────────────────────
  backtest-full:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-full
    environment:
      - THE_ODDS_API_KEY=${THE_ODDS_API_KEY}
      - API_BASKETBALL_KEY=${API_BASKETBALL_KEY}
      - SEASONS=${SEASONS:-2023-2024,2024-2025,2025-2026}
      - MARKETS=${MARKETS:-all}
      - MIN_TRAINING=${MIN_TRAINING:-80}
    volumes:
      - ./data:/app/data
      - ./secrets:/app/secrets:ro
      - backtest_cache:/app/.cache
    command: ["full"]
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # DATA CHECK ONLY
  # Confirms canonical training_data.csv is present (no backtest)
  # ─────────────────────────────────────────────────────────────────────────
  backtest-data:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-data
    environment:
      - THE_ODDS_API_KEY=${THE_ODDS_API_KEY}
      - API_BASKETBALL_KEY=${API_BASKETBALL_KEY}
      - SEASONS=${SEASONS:-2023-2024,2024-2025,2025-2026}
    volumes:
      - ./data:/app/data
      - backtest_cache:/app/.cache
    command: ["data"]
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # BACKTEST ONLY
  # Runs backtest on canonical training_data.csv (no API calls)
  # ─────────────────────────────────────────────────────────────────────────
  backtest-only:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-only
    environment:
      - MARKETS=${MARKETS:-all}
      - MIN_TRAINING=${MIN_TRAINING:-80}
    volumes:
      - ./data:/app/data
    command: ["backtest"]
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # PRODUCTION MODEL BACKTEST (FROZEN ARTIFACTS)
  # Uses committed models under models/production + leakage-safe feature rebuild
  # ─────────────────────────────────────────────────────────────────────────
  backtest-prod:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-prod
    environment:
      - MARKETS=${MARKETS:-all}
    volumes:
      - ./data:/app/data
    command: ["prod"]
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # VALIDATION
  # Validates training data integrity
  # ─────────────────────────────────────────────────────────────────────────
  backtest-validate:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-validate
    volumes:
      - ./data:/app/data:ro
    command: ["validate"]
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # INTERACTIVE SHELL
  # For debugging and development
  # ─────────────────────────────────────────────────────────────────────────
  backtest-shell:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-shell
    environment:
      - THE_ODDS_API_KEY=${THE_ODDS_API_KEY}
      - API_BASKETBALL_KEY=${API_BASKETBALL_KEY}
    volumes:
      - ./data:/app/data
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
    command: ["shell"]
    stdin_open: true
    tty: true
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # DIAGNOSTIC
  # Run diagnostics to troubleshoot issues
  # ─────────────────────────────────────────────────────────────────────────
  backtest-diagnose:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-diagnose
    environment:
      - THE_ODDS_API_KEY=${THE_ODDS_API_KEY}
      - API_BASKETBALL_KEY=${API_BASKETBALL_KEY}
      - SEASONS=${SEASONS:-2023-2024,2024-2025,2025-2026}
      - MARKETS=${MARKETS:-all}
    volumes:
      - ./data:/app/data
    command: ["diagnose"]
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # PARALLEL MARKET BACKTESTS (6 independent services)
  # Run all 6 markets in parallel for timing efficiency
  # Usage: docker compose -f docker-compose.backtest.yml up backtest-fg-spread backtest-fg-total backtest-1h-spread backtest-1h-total backtest-fg-ml backtest-1h-ml
  # ─────────────────────────────────────────────────────────────────────────
  backtest-fg-spread:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-fg-spread
    environment:
      - MARKETS=fg_spread
      - MIN_TRAINING=${MIN_TRAINING:-80}
      - FG_SPREAD_JUICE=${FG_SPREAD_JUICE:--110}
      - FG_SPREAD_CONF=${FG_SPREAD_CONF:-0.55}
    volumes:
      - ./data:/app/data
    command: >
      python scripts/backtest_extended.py
      --data /app/data/processed/training_data.csv
      --markets fg_spread
      --fg-spread-juice ${FG_SPREAD_JUICE:--110}
      --fg-spread-conf ${FG_SPREAD_CONF:-0.55}
      --min-train ${MIN_TRAINING:-80}
      --output-json /app/data/backtest_results/fg_spread_results.json
    networks:
      - backtest-network

  backtest-fg-total:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-fg-total
    environment:
      - MARKETS=fg_total
      - MIN_TRAINING=${MIN_TRAINING:-80}
      - FG_TOTAL_JUICE=${FG_TOTAL_JUICE:--110}
      - FG_TOTAL_CONF=${FG_TOTAL_CONF:-0.55}
    volumes:
      - ./data:/app/data
    command: >
      python scripts/backtest_extended.py
      --data /app/data/processed/training_data.csv
      --markets fg_total
      --fg-total-juice ${FG_TOTAL_JUICE:--110}
      --fg-total-conf ${FG_TOTAL_CONF:-0.55}
      --min-train ${MIN_TRAINING:-80}
      --output-json /app/data/backtest_results/fg_total_results.json
    networks:
      - backtest-network

  backtest-fg-ml:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-fg-ml
    environment:
      - MARKETS=fg_moneyline
      - MIN_TRAINING=${MIN_TRAINING:-80}
      - FG_ML_CONF=${FG_ML_CONF:-0.55}
    volumes:
      - ./data:/app/data
    command: >
      python scripts/backtest_extended.py
      --data /app/data/processed/training_data.csv
      --markets fg_moneyline
      --fg-ml-conf ${FG_ML_CONF:-0.55}
      --min-train ${MIN_TRAINING:-80}
      --output-json /app/data/backtest_results/fg_moneyline_results.json
    networks:
      - backtest-network

  backtest-1h-spread:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-1h-spread
    environment:
      - MARKETS=1h_spread
      - MIN_TRAINING=${MIN_TRAINING:-80}
      - 1H_SPREAD_JUICE=${1H_SPREAD_JUICE:--110}
      - 1H_SPREAD_CONF=${1H_SPREAD_CONF:-0.55}
    volumes:
      - ./data:/app/data
    command: >
      python scripts/backtest_extended.py
      --data /app/data/processed/training_data.csv
      --markets 1h_spread
      --1h-spread-juice ${1H_SPREAD_JUICE:--110}
      --1h-spread-conf ${1H_SPREAD_CONF:-0.55}
      --min-train ${MIN_TRAINING:-80}
      --output-json /app/data/backtest_results/1h_spread_results.json
    networks:
      - backtest-network

  backtest-1h-total:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-1h-total
    environment:
      - MARKETS=1h_total
      - MIN_TRAINING=${MIN_TRAINING:-80}
      - 1H_TOTAL_JUICE=${1H_TOTAL_JUICE:--110}
      - 1H_TOTAL_CONF=${1H_TOTAL_CONF:-0.55}
    volumes:
      - ./data:/app/data
    command: >
      python scripts/backtest_extended.py
      --data /app/data/processed/training_data.csv
      --markets 1h_total
      --1h-total-juice ${1H_TOTAL_JUICE:--110}
      --1h-total-conf ${1H_TOTAL_CONF:-0.55}
      --min-train ${MIN_TRAINING:-80}
      --output-json /app/data/backtest_results/1h_total_results.json
    networks:
      - backtest-network

  backtest-1h-ml:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-1h-ml
    environment:
      - MARKETS=1h_moneyline
      - MIN_TRAINING=${MIN_TRAINING:-80}
      - 1H_ML_CONF=${1H_ML_CONF:-0.55}
    volumes:
      - ./data:/app/data
    command: >
      python scripts/backtest_extended.py
      --data /app/data/processed/training_data.csv
      --markets 1h_moneyline
      --1h-ml-conf ${1H_ML_CONF:-0.55}
      --min-train ${MIN_TRAINING:-80}
      --output-json /app/data/backtest_results/1h_moneyline_results.json
    networks:
      - backtest-network

  # ─────────────────────────────────────────────────────────────────────────
  # PARALLEL BACKTEST AGGREGATOR
  # Aggregates results from all 6 market backtests into unified report
  # ─────────────────────────────────────────────────────────────────────────
  backtest-aggregate:
    build:
      context: .
      dockerfile: Dockerfile.backtest
    container_name: nba-backtest-aggregate
    volumes:
      - ./data:/app/data
    command: python scripts/aggregate_backtest_results.py
    depends_on:
      - backtest-fg-spread
      - backtest-fg-total
      - backtest-fg-ml
      - backtest-1h-spread
      - backtest-1h-total
      - backtest-1h-ml
    networks:
      - backtest-network

volumes:
  backtest_cache:

networks:
  backtest-network:
    name: nba-backtest-network
